/**
* Description: populates service portal forms, which contain numerous mandatory fields, like stings, numbers, dates, tickboxes and references;
Script interact with angular and server-side to populate reference fields;
Please note that service portal may use another variables naming convention, depending on platform release, this may cause errors;
* Note: The duration of the script execution depends on quantity of fields (and especially on a nubmer of records in reference tables);
        Script may cause errors if interacts with onChange client scripts;
* Usage: when the form loaded run the function from console.
* PLEASE BEWARE OF: using on forms which contain references to tables with many thousands records, this may affect the instance performance;
*/
function spFormTest() {
    var DEBUG = true,
        LOG_PREFIX = "[DEBUG]",
        log = function () {
            if (DEBUG) {
                var a = Array.prototype.slice.call(arguments);
                a.unshift(LOG_PREFIX + " "), console.warn.apply(console, a);
            }
        };
    var simulateClick = function (elem) {
        // Create event
        var evt = new MouseEvent("click", {
            bubbles: true,
            cancelable: true,
            view: window
        });
        // If cancelled, don't dispatch our event
        var cancelled = !elem.dispatchEvent(evt);
        if (cancelled) {
            // A handler called preventDefault.
            log("cancelled");
        } else {
            // None of the handlers called preventDefault.
            log("clicked");
        }
    };

    function getTodayDate() {
        var today = new Date();
        var dd = String(today.getDate()).padStart(2, "0");
        var mm = String(today.getMonth() + 1).padStart(2, "0"); //January is 0!
        var yyyy = today.getFullYear();
        today = dd + "/" + mm + "/" + yyyy;
        return today;
    }

    function runReport(a, b, c) {
        console.warn(a);
        if (b) {
            console.warn(b);
        }
        if (c) {
            console.warn(c);
        }
    }

    function setReferenceRandom(fieldname) {
        var gf = angular.element(document.getElementById(fieldname)).scope().getGlideForm(); //g_form
        gf.getReference(fieldname, function (gr) {
            var refTable = gr.getTableName();
            var randomId;
            log(refTable);
            if (refTable) {
                var ref = new GlideRecord(refTable);
                ref.orderByDesc("sys_id");
                ref.query(function (ref) {
                    log(ref.getRowCount());
                    var a = [];
                    while (ref.next()) {
                        a.push(ref.sys_id.toString());
                    }
                    for (var i = 0; i < a.length; i++) {
                        randomId = a[Math.floor(Math.random() * a.length)];
                    }
                    log(randomId);
                    gf.setValue(fieldname, randomId);
                });
            }
        });
    }
    var inputs = angular.element(document.getElementsByTagName("input"));
    var inp = [];
    for (var i = 0; i < inputs.length; i++) {
        var input = inputs[i];
        switch (input.type) {
            case "text":
                if (
                    input.name != "" &&
                    input.name != "q" &&
                    input.name.indexOf("date") == -1
                ) {
                    setReferenceRandom(input.name);
                }
                if (input.name != "" && input.name.indexOf("u_") > -1) {
                    var gForm = angular.element(document.getElementById(input.name)).scope().getGlideForm(); //g_form
                    log(input.name);
                    gForm.setMandatory(input.name, false);
                    if (
                        input.name.indexOf("number") > -1 ||
                        input.name.indexOf("cost") > -1 ||
                        input.name.indexOf("score") > -1
                    ) {
                        gForm.setValue(input.name, "123");
                    } else if (
                        input.name.indexOf("email") > -1 ||
                        input.name.indexOf("e-mail") > -1
                    ) {
                        gForm.setValue(input.name, "name.lastname@company.com");
                    } else if (input.name.indexOf("date") > -1) {
                        var somedate = getTodayDate();
                        gForm.setValue(input.name, somedate);
                    } else {
                        gForm.setValue(input.name, "some text here");
                    }
                    inp.push(input.name);
                }
                break;
            case "checkbox":
                simulateClick(input);
                break;
        }
    }
    var textareas = angular.element(document.getElementsByTagName("textarea"));
    var text = [];
    for (var i = 0; i < textareas.length; i++) {
        var textarea = textareas[i];
        if (textarea.name != "" && textarea.name.indexOf("u_") > -1) {
            var gfrm = angular.element(document.getElementById(textarea.name)).scope().getGlideForm(); //g_form
            log(textarea.name);
            gfrm.setMandatory(textarea.name, false);
            gfrm.setValue(textarea.name, "some more text here");
        }
        text.push(textarea.name);
    }

    runReport(inp, text);
}
//usage
spFormTest();
